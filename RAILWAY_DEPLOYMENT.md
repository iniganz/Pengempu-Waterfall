# Railway Deployment Guide - Pengempu Waterfall

## Persiapan Awal

### 1. Setup Railway Project
- Buat project baru di [Railway.app](https://railway.app)
- Connect dengan repository GitHub
- Add MySQL database service (atau PostgreSQL sesuai kebutuhan)

### 2. Environment Variables
Set environment variables berikut di Railway dashboard → Variables:

**Database (otomatis dari Railway MySQL service):**
```
DB_CONNECTION=mysql
DB_HOST=mysql.railway.internal
DB_PORT=3306
DB_DATABASE=railway
DB_USERNAME=root
DB_PASSWORD=<auto-generated>
```

**Application:**
```
APP_NAME="PENGEMPU-WATERFALL"
APP_ENV=production
APP_DEBUG=false
APP_KEY=<generate with: php artisan key:generate --show>
APP_URL=https://your-app.up.railway.app
ASSET_URL=https://your-app.up.railway.app
```

**Mail (contoh SMTP Gmail):**
```
MAIL_MAILER=smtp
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=pengempuw@gmail.com
MAIL_PASSWORD=<app-specific-password>
MAIL_FROM_ADDRESS=pengempuw@gmail.com
MAIL_FROM_NAME="Admin Waterfall Pengempu"
```

**Session & Cache:**
```
SESSION_DRIVER=database
CACHE_STORE=database
QUEUE_CONNECTION=database
FILESYSTEM_DISK=public
```

**Midtrans (payment gateway):**
```
MIDTRANS_SERVER_KEY=<your-server-key>
MIDTRANS_CLIENT_KEY=<your-client-key>
MIDTRANS_IS_PRODUCTION=false
MIDTRANS_IS_SANITIZED=true
MIDTRANS_IS_3DS=true
```

### 3. Deploy Configuration

Di Railway Settings → Deploy, set **Pre-deploy Command**:
```bash
php artisan migrate --force && php artisan db:seed --force && php artisan storage:link
```

Ini akan:
- Menjalankan migrasi database
- Mengisi data awal (seeders)
- Membuat symlink storage untuk file upload

### 4. Build & Start Commands (otomatis oleh Nixpacks)
Railway akan mendeteksi Laravel project dan menjalankan:
- Build: `composer install --no-dev --optimize-autoloader`
- Start: `php artisan serve --host=0.0.0.0 --port=$PORT`

Jika perlu custom command, set di Railway Settings → Deploy.

## Troubleshooting

### Error: "Undefined variable $testimonials"
**Penyebab:** `PublikController@index` tidak mengirim data testimonial ke view.

**Solusi:** Sudah diperbaiki dengan menambahkan query testimonial di controller.

### Error: "Product tidak ditemukan"
**Penyebab:** Seeder belum dijalankan atau produk dengan slug `pengempu-waterfall` tidak ada.

**Solusi:**
```bash
railway run php artisan db:seed --class=ProductSeeder --force
```

### Error: "SQLSTATE[HY000] [2002] No such host is known"
**Penyebab:** Mencoba menjalankan `railway run` dari lokal dengan host internal Railway.

**Solusi:** Gunakan Railway Shell:
```bash
railway shell
php artisan migrate --force
php artisan db:seed --force
```

### Gallery Images tidak muncul
**Penyebab:** Railway menggunakan ephemeral filesystem - file upload hilang setiap deploy/restart.

**Solusi Sementara (Development):**
- Gunakan gambar dari `public/images/` yang di-commit ke repo
- Jangan upload gambar baru via dashboard (akan hilang saat restart)

**Solusi Production (Recommended):**

**1. Menggunakan Railway Volume (Beta)**
```bash
# Di Railway Dashboard:
# 1. Go to Settings → Volumes
# 2. Add New Volume → Mount path: /app/storage/app/public
# 3. Redeploy aplikasi
```

**2. Menggunakan Cloud Storage (S3/DigitalOcean Spaces/Cloudinary)**

Install package S3:
```bash
composer require league/flysystem-aws-s3-v3 "^3.0"
```

Set di Railway Variables:
```
FILESYSTEM_DISK=s3
AWS_ACCESS_KEY_ID=your_key
AWS_SECRET_ACCESS_KEY=your_secret
AWS_DEFAULT_REGION=us-east-1
AWS_BUCKET=your_bucket_name
AWS_URL=https://your_bucket.s3.amazonaws.com
```

Update `GalleryAdminController` untuk gunakan disk yang benar:
```php
// Ganti:
$path = $request->file('image')->store('products', 'public');

// Menjadi:
$path = $request->file('image')->store('products', config('filesystems.default'));
```

**3. Menggunakan ImgBB (Gratis & Simple)**
- Sign up di https://imgbb.com
- Get API key
- Upload gambar via API
- Simpan URL di database (bukan path file)

**Catatan:** Untuk sementara, gambar dari seeder (yang ada di `public/images/`) akan tetap tampil karena ter-commit di repo.

### Email tidak terkirim
**Penyebab:** MAIL_MAILER masih `log` atau kredensial SMTP salah.

**Solusi:**
1. Set MAIL_MAILER=smtp di Railway variables
2. Gunakan App Password (bukan password Gmail biasa)
3. Test dengan: `railway run php artisan tinker` lalu:
   ```php
   Mail::raw('Test', function($m) { $m->to('test@example.com')->subject('Test'); });
   ```

## Deploy Workflow

### Pertama Kali Deploy
1. Push code ke GitHub
2. Railway auto-deploy (trigger dari GitHub webhook)
3. Pre-deploy command akan jalan: migrate + seed + storage:link
4. Aplikasi start
5. Akses `https://your-app.up.railway.app`

### Update Code
1. Commit & push perubahan ke GitHub
2. Railway otomatis rebuild & redeploy
3. Pre-deploy command akan jalan lagi (aman, migrate hanya jalankan migration baru)

### Manual Trigger Deploy
Di Railway dashboard → Deployments → klik "Deploy" atau gunakan CLI:
```bash
railway up
```

## Maintenance Commands

### Check Logs
```bash
railway logs
```

### Run Artisan Commands
```bash
railway run php artisan cache:clear
railway run php artisan config:clear
railway run php artisan route:list
```

### Database Query (Tinker)
```bash
railway run php artisan tinker
```

### Backup Database (dari Railway Shell)
```bash
railway shell
mysqldump -h $DB_HOST -u $DB_USERNAME -p$DB_PASSWORD $DB_DATABASE > backup.sql
```

## Monitoring

- **Logs:** Railway dashboard → Deployments → View logs
- **Metrics:** Railway dashboard → Metrics (CPU, Memory, Network)
- **Database:** Railway dashboard → MySQL service → Connect untuk query langsung

## Security Checklist

- [x] `APP_DEBUG=false` di production
- [x] `APP_ENV=production`
- [x] APP_KEY ter-generate dan unik
- [x] Database credentials aman (dari Railway service variable)
- [x] MAIL credentials disimpan di env (jangan commit ke repo)
- [x] `/storage-link` route hanya aktif di local (sudah disabled di production)
- [x] CSRF protection aktif (Laravel default)
- [x] HTTPS aktif (Railway default untuk `.up.railway.app`)

## Fitur yang Harus Dicek Setelah Deploy

1. **Homepage:** `GET /` → tampil testimonial + hero section
2. **Product Detail:** `GET /product` → detail Pengempu Waterfall
3. **Products List:** `GET /products` → daftar semua produk
4. **Gallery Admin:** `GET /dashboard/gallery` (butuh login) → upload/manage images
5. **Contact Form:** `POST /contact/send` → kirim email ke pengempuw@gmail.com
6. **Booking & Payment:** `/booking/{product}` → integrasi Midtrans

## Support

Jika ada issue, cek:
1. Railway logs: `railway logs`
2. Laravel logs: di Railway Shell → `tail -f storage/logs/laravel.log`
3. Database connection: `railway run php artisan db:show`
